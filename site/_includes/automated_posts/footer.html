<script type="text/javascript" defer>
  fetch("https://web-production-9b27.up.railway.app/facebook_posts?limit=20", {
    method: 'GET'
  })
  .then(function(response) {
    return response.json();
  })
  .then(function(jsonObject) {
    var posts = jsonObject && jsonObject.data;
    if (posts) {
        var noticiasContainer = document.getElementById('noticias-container');
        noticiasContainer.innerHTML = null; // Clear out existing skeleton loaders
        for (index = 0; index < posts.length; ++index) {
          var post = posts[index].attributes;
          var postContainer = document.createElement('div');
          postContainer.setAttribute('class', 'column is-full mb-2 mt-1');
          if (!post.message) continue;

          var message = post.message.replace('#', '<br/><br/>#');
          if (post.message_tags) {
            for (tagIndex = 0; tagIndex < post.message_tags.length; tagIndex++) {
              var tag = post.message_tags[tagIndex].replaceAll('=>', ':')
              var parsedTag = JSON.parse(tag);
              if (parsedTag.type === 'page') {
                message = message.replace(
                  parsedTag.name,
                  `<a href='https://www.facebook.com/${parsedTag.id}' target='_blank'>${parsedTag.name}</a>`
                );
              }
            }
          }
          var htmlContent = `{% include automated_posts/post.html %}`
            .replace('AUTOMATED_POST_IMAGE_URL', post.full_picture)
            .replace('AUTOMATED_POST_MESSAGE', message)
            .replace('AUTOMATED_POST_LIKE_COUNT', post.like_count)
            .replace('AUTOMATED_POST_COMMENT_COUNT', post.comment_count)
            .replace('AUTOMATED_POST_URL', post.post_url);
          postContainer.innerHTML = htmlContent;
          noticiasContainer.appendChild(postContainer);
        }
      }
  })
  .catch(function(e) {
    window.trackEvent('loading_facebook_posts_failed');
  });
</script>
